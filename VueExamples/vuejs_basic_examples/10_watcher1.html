<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Vue.js</title>
    <!--导入映射表-->
    <script type="importmap">
      {
        "imports": {
          "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js",
          "es-toolkit": "https://esm.sh/es-toolkit@%5E1",
          "axios": "https://unpkg.com/axios@1.10.0/dist/esm/axios.min.js"
        }
      }
    </script>
    <style>
      label,
      span {
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div>
        <input type="button" value="Change todoId" @click="todo.todoId++" />
        <p>
          <label>Todo Id:</label>
          <span v-text="todo.todoId"></span>
          <label>Todo Title:</label>
          <span v-text="todo.data.title"></span>
        </p>
      </div>
    </div>

    <script type="module">
      import { createApp, ref, watch, watchEffect, onWatcherCleanup } from "vue"
      import axios from "axios"

      const app = createApp({
        setup() {
          //   const todoId = ref(1)
          //   const data = ref({})

          const todo = ref({
            todoId: 1,
            data: {},
          })

          // watch(
          //   () => todoId.value,
          //   async (newId, oldId) => {
          //     const res = await axios.get(`https://jsonplaceholder.typicode.com/todos/${newId}`)
          //     data.value = res.data
          //   },
          //   {
          //     immediate: true,
          //   }
          // )

          watch(
            () => todo.value.todoId,
            (newId, oldId, onCleanup) => {
              // 创建新的AbortController用于取消请求
              const controller = new AbortController()

              // 发起异步请求获取数据
              axios
                .get(`https://jsonplaceholder.typicode.com/todos/${newId}`, {
                  signal: controller.signal,
                })
                .then(res => {
                  todo.value.data = res.data
                })
                .catch(error => {
                  // 更好地处理错误，区分取消请求和其他错误
                  if (error.name !== "AbortError") {
                    console.error("Error fetching todo:", error)
                  }
                })

              // 注册清理函数，用于在监听器重新触发时取消之前的请求
              // onWatcherCleanup(() => {
              //   controller.abort()
              // })

              onCleanup(() => {
                controller.abort()
              })
            },
            {
              immediate: true,
            }
          )

          // watchEffect(() => {
          //   try {
          //     const controller = new AbortController()
          //     axios
          //       .get(`https://jsonplaceholder.typicode.com/todos/${todo.value.todoId}`, {
          //         signal: controller.signal,
          //       })
          //       .then(res => {
          //         todo.value.data = res.data
          //       })

          //     onWatcherCleanup(() => {
          //       controller.abort()
          //     })
          //   } catch (error) {
          //     console.log(error)
          //   }
          // })

          return {
            todo,
          }
        },
      })

      app.mount("#app")
    </script>
  </body>
</html>
